<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
	<title>d2l-my-dashboards test</title>
	<script src="../../webcomponentsjs/webcomponents-lite.js"></script>

	<!-- For IE11 -->
	<script src="../../lie/dist/lie.polyfill.min.js"></script>
	<!-- For IE11 -->
	<script src="../../fetch/fetch.js"></script>

	<script src="../../web-component-tester/browser.js"></script>
	<link rel="import" href="../d2l-my-dashboards.html">
</head>

<body>
	<test-fixture id="d2l-my-dashboards-fixture">
		<template>
			<d2l-my-dashboards dashboards-url="https://tenant.analytics.api.dev.brightspace.com/dashboards"></d2l-my-dashboards>
		</template>
	</test-fixture>
	<script>
		var dashboardUrl1 = 'https://tenant.analytics.api.dev.brightspace.com/dashboards/1';
		var dashboardUrl2 = 'https://tenant.analytics.api.dev.brightspace.com/dashboards/2';

		var dashboardsResponse = {
			'entities': [
				{
					'class': [
						'dashboard'
					],
					'rel': [
						'https://api.brightspace.com/rels/analytics-dashboards'
					],
					'href': dashboardUrl1
				},
				{
					'class': [
						'dashboard'
					],
					'rel': [
						'https://api.brightspace.com/rels/analytics-dashboards'
					],
					'href': dashboardUrl2
				}
			]

		};

		var dashboardResponse1 = {
			'properties': {
				'name': 'DisplayName1',
				'link': 'https://www.d2l.com/'
			},
			'entities': [
				{
					'class': [
						'anlytics-dashboard-image'
					],
					'rel': [
						'https://api.brightspace.com/rels/analytics-dashboard-image'
					],
					'href': './static/dashboard_1.jpg'
				},
			]

		};

		var dashboardResponse2 = {
			'properties': {
				'name': 'DisplayName2',
				'link': 'https://www.d2l.com/'
			},
			'entities': [
				{
					'class': [
						'anlytics-dashboard-image'
					],
					'rel': [
						'https://api.brightspace.com/rels/analytics-dashboard-image'
					],
					'href': './static/dashboard_2.jpg'
				},
			]
		};

		suite('d2l-my-dashboards', function() {

			let element;
			setup(function(done) {
				element = fixture('d2l-my-dashboards-fixture');

				element._fetchEntity = sinon.stub();
				element._fetchEntity
					.withArgs(sinon.match(dashboardUrl1))
					.returns(Promise.resolve(window.D2L.Hypermedia.Siren.Parse(dashboardResponse1)));
				element._fetchEntity
					.withArgs(sinon.match(dashboardUrl2))
					.returns(Promise.resolve(window.D2L.Hypermedia.Siren.Parse(dashboardResponse2)));
				element._fetchEntity
					.withArgs(sinon.match('https://tenant.analytics.api.dev.brightspace.com/dashboards'))
					.returns(Promise.resolve(window.D2L.Hypermedia.Siren.Parse(dashboardsResponse)));

				flush(done);
			});

			test('instantiating the element works', function() {
				assert.equal(element.is, 'd2l-my-dashboards');
			});

			test('after fetching dashboards, the correct number of dashboard tiles are displayed', function(done) {
				element._fetchDashboards().then(function() {
					Polymer.dom.flush();

					var d2lImageTiles = Polymer.dom(element.root).querySelectorAll('d2l-dashboard-tile');
					assert.equal(d2lImageTiles.length, 2);

					var dashboard1 = d2lImageTiles[0].dashboard;
					assert.equal(dashboard1.link, dashboardResponse1.properties.link)
					assert.equal(dashboard1.name, dashboardResponse1.properties.name)
					assert.equal(dashboard1.imgUrl, dashboardResponse1.entities[0].href)

					var dashboard2 = d2lImageTiles[1].dashboard;
					assert.equal(dashboard2.link, dashboardResponse2.properties.link)
					assert.equal(dashboard2.name, dashboardResponse2.properties.name)
					assert.equal(dashboard2.imgUrl, dashboardResponse2.entities[0].href)

					done();
				});
			});

		});
	</script>
</body>

</html>