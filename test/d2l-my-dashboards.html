<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
	<title>d2l-my-dashboards test</title>
	<script src="../../webcomponentsjs/webcomponents-lite.js"></script>

	<!-- For IE11 -->
	<script src="../../lie/dist/lie.polyfill.min.js"></script>
	<!-- For IE11 -->
	<script src="../../fetch/fetch.js"></script>

	<script src="../../web-component-tester/browser.js"></script>
	<link rel="import" href="../d2l-my-dashboards.html">
</head>

<body>
	<test-fixture id="d2l-my-dashboards-fixture">
		<template>
			<d2l-my-dashboards dashboards-url="https://tenant.analytics.api.dev.brightspace.com/dashboards"></d2l-my-dashboards>
		</template>
	</test-fixture>
	<script>
		var dashboardUrl1 = 'https://tenant.analytics.api.dev.brightspace.com/dashboards/1';
		var dashboardUrl2 = 'https://tenant.analytics.api.dev.brightspace.com/dashboards/2';

		var dashboardsResponse = {
			'entities': [
				{
					'class': [
						'dashboard'
					],
					'rel': [
						'https://api.brightspace.com/rels/analytics-dashboards'
					],
					'href': dashboardUrl1
				},
				{
					'class': [
						'dashboard'
					],
					'rel': [
						'https://api.brightspace.com/rels/analytics-dashboards'
					],
					'href': dashboardUrl2
				}
			]

		};

		var dashboardResponse1 = {
			'properties': {
				'name': 'DisplayName1',
				'link': 'https://www.d2l.com/'
			},
			'entities': [
				{
					'class': [
						'anlytics-dashboard-image'
					],
					'rel': [
						'https://api.brightspace.com/rels/analytics-dashboard-image'
					],
					'href': './static/dashboard_1.jpg'
				},
			]

		};

		var dashboardResponse2 = {
			'properties': {
				'name': 'DisplayName2',
				'link': 'https://www.d2l.com/'
			},
			'entities': [
				{
					'class': [
						'anlytics-dashboard-image'
					],
					'rel': [
						'https://api.brightspace.com/rels/analytics-dashboard-image'
					],
					'href': './static/dashboard_2.jpg'
				},
			]
		};

		suite('d2l-my-dashboards', function() {

			var element;
			var sandbox;

			setup(function(done) {
				sandbox = sinon.sandbox.create();
				element = fixture('d2l-my-dashboards-fixture');

				element._fetchEntity = sinon.stub();
				element._fetchEntity
					.withArgs(sinon.match(dashboardUrl1))
					.returns(Promise.resolve(window.D2L.Hypermedia.Siren.Parse(dashboardResponse1)));
				element._fetchEntity
					.withArgs(sinon.match(dashboardUrl2))
					.returns(Promise.resolve(window.D2L.Hypermedia.Siren.Parse(dashboardResponse2)));
				element._fetchEntity
					.withArgs(sinon.match('https://tenant.analytics.api.dev.brightspace.com/dashboards'))
					.returns(Promise.resolve(window.D2L.Hypermedia.Siren.Parse(dashboardsResponse)));

				flush(done);
			});

			teardown(function() {
				sandbox.restore();
			});

			test('instantiating the element works', function() {
				assert.equal(element.is, 'd2l-my-dashboards');
			});

			test('after fetching dashboards, the correct number of dashboard tiles are displayed', function(done) {
				element._fetchDashboards().then(function() {
					Polymer.dom.flush();

					var d2lDashboardTiles = Polymer.dom(element.root).querySelectorAll('d2l-dashboard-tile');
					assert.equal(d2lDashboardTiles.length, 2);

					var dashboard1 = d2lDashboardTiles[0];
					assert.equal(dashboard1._link, dashboardResponse1.properties.link);
					assert.equal(dashboard1._name, dashboardResponse1.properties.name);
					assert.equal(dashboard1._imgUrl, dashboardResponse1.entities[0].href);

					var dashboard2 = d2lDashboardTiles[1];
					assert.equal(dashboard2._link, dashboardResponse2.properties.link);
					assert.equal(dashboard2._name, dashboardResponse2.properties.name);
					assert.equal(dashboard2._imgUrl, dashboardResponse2.entities[0].href);

					done();
				});
			});

			test('on open-edit-dashboard event the d2l-simple-overlay should open with correct input value', function(done) {
				var overlay = Polymer.dom(element.root).querySelector('#dashboard-edit-overlay');
				var spy = sandbox.spy(overlay, 'open');

				var expectedInitialInputValue = 'expectedInitialInputValue';
				var event = new CustomEvent('open-edit-dashboard', { detail: { displayName: expectedInitialInputValue } });

				element.addEventListener('open-edit-dashboard', function() {
					var initialInputValue = Polymer.dom(overlay).querySelector('#display-name-input').value;

					expect(spy).to.have.been.called;
					assert.equal(initialInputValue, expectedInitialInputValue);

					done();
				});

				element.dispatchEvent(event);
			});

<<<<<<< HEAD
			test('update display name button fires close-edit-dashboard event', function(done) {
=======
			test('update display name button first close-edit-dashboard event', function(done) {
>>>>>>> US97887 - Update to display name should show a change in the UI
				var overlay = Polymer.dom(element.root).querySelector('#dashboard-edit-overlay');

				// Mock editor context
				element._editorContext = {};
				element._editorContext.index = 0;
				element._editorContext.updateDisplayName = function() {
					return Promise.resolve();
				};
				// Mock dashboard
				element._dashboards = [window.D2L.Hypermedia.Siren.Parse(dashboardResponse1)];

				element.addEventListener('close-edit-dashboard', function() {
					assert.isOk('close-edit-dashboard event was fired');
					done();
				});

				Polymer.dom(overlay).querySelector('#display-name-update-button').click();
			});

			test('cancel display name button fires close-edit-dashboard event', function(done) {
				var overlay = Polymer.dom(element.root).querySelector('#dashboard-edit-overlay');

				element.addEventListener('close-edit-dashboard', function() {
					assert.isOk('close-edit-dashboard event was fired');
					done();
				});

				Polymer.dom(overlay).querySelector('#display-name-cancel-button').click();
			});

			test('When updating display name of dashboard at index 1, ensure user will see updated name', function(done) {
				var expectedDisplayName = 'expectedDisplayName';
				var dashboardIndexToUpdate = 1;

				element._fetchDashboards().then(function() {
					Polymer.dom.flush();

					element._editorContext = {};
					element._editorContext.index = dashboardIndexToUpdate;
					element._editorContext.updateDisplayName = function() {
						return Promise.resolve('Mock request to update backend');
					};

					var dashboardEditor = Polymer.dom(element.root).querySelector('#dashboard-edit-overlay');
					Polymer.dom(dashboardEditor).querySelector('#display-name-input').value = expectedDisplayName;

					element.addEventListener('close-edit-dashboard', function() {
						Polymer.dom.flush();

						var d2lImageTiles = Polymer.dom(element.root).querySelectorAll('d2l-dashboard-tile');
						var updatedDashboard = d2lImageTiles[dashboardIndexToUpdate];

						assert.equal(updatedDashboard._name, expectedDisplayName);
						done();
					});

					Polymer.dom(dashboardEditor).querySelector('#display-name-update-button').click();
				});
			});
		});
	</script>
</body>

</html>