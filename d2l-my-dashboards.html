<link rel='import' href='../polymer/polymer.html'>
<link rel="import" href="../d2l-fetch-siren-entity-behavior/d2l-fetch-siren-entity-behavior.html">

<link rel="import" href="./localize-behavior.html">
<link rel="import" href="./src/d2l-dashboard-editor.html">
<link rel="import" href="./src/d2l-dashboard-tile.html">


<dom-module id='d2l-my-dashboards'>
	<template strip-whitespace>
		<style>
			:host {
				display: block;
			}
			.dashboards-tile-grid {
				display: -ms-grid;
				display: grid;
				grid-column-gap: 15px;
			}
			.dashboards-tile-grid.columns-3 {
				grid-template-columns: repeat(3, 1fr);
				-ms-grid-columns: 1fr 15px 1fr 15px 1fr;
			}
			.dashboards-tile-grid.columns-2 {
				grid-template-columns: repeat(2, 1fr);
				-ms-grid-columns: 1fr 15px 1fr;
			}
			.dashboards-tile-grid.columns-1 {
				grid-template-columns: 100%;
				-ms-grid-columns: 100%;
			}
		</style>

		<d2l-dashboard-editor
			hidden="[[_dashboardEditorHidden]]"
			editor-context="[[_editorContext]]">
		</d2l-dashboard-editor>

		<div id="dashboard-tile-container" class="dashboards-tile-grid columns-2">
			<template is='dom-repeat' id='listOfDashboards' items='[[_dashboards]]' as='dashboard'>
				<div class="dashboard-tile">
					<d2l-dashboard-tile
						index="[[index]]"
						dashboard="[[dashboard]]">
					</d2l-dashboard-tile>
				</div>
			</template>
		</div>
	</template>

	<script src="./src/ie-polyfills.js"></script> <!-- For IE11 -->
	<script>
		Polymer({
			is: 'd2l-my-dashboards',
			properties: {
				dashboardsUrl: {
					type: String
				},
				_dashboards: {
					type: Array
				},
				_dashboardEditorHidden: {
					type: Boolean,
					value: true
				},
				_editorContext: {
					type: Object,
					value: {}
				},
				_numberOfColumns: {
					type: Number,
					value: 2,
					observer: '_styleTilesForInternetExplorer'
				}
			},
			behaviors: [
				D2L.PolymerBehaviors.AnalyticsDashboards.LocalizeBehavior,
				D2L.PolymerBehaviors.FetchSirenEntityBehavior
			],
			listeners: {
				'dashboard-editor-closed': '_closeEditDashboardView',
				'dashboard-editor-opened': '_openEditDashboardView',
				'dashboard-name-updated': '_updateDashboardName'
			},
			attached: function() {
				Polymer.RenderStatus.afterNextRender(this, function() {
					this._onResize();
					this._styleTilesForInternetExplorer();
					window.addEventListener('resize', this._onResize.bind(this));
				});
			},
			ready: function() {
				this._fetchDashboards();
			},
			_closeEditDashboardView: function() {
				this.set('_dashboardEditorHidden', true);
			},
			_fetchDashboards: function() {
				return this._fetchEntity(this.dashboardsUrl)
					.then(function(data) {
						var getDashboardEntities = data.getSubEntitiesByRel('https://api.brightspace.com/rels/analytics-dashboards').map(function(e) {
							return this._fetchEntity(e.href);
						}.bind(this));
						return Promise.all(getDashboardEntities);
					}.bind(this))
					.then(function(dashboardEntities) {
						this.set('_dashboards', dashboardEntities);
					}.bind(this));
			},
			_getContainerWidth: function() {
				return this.offsetWidth;
			},
			_openEditDashboardView: function(e) {
				var editorContext = e.detail ? e.detail : {};

				this.set('_editorContext', editorContext);
				this.set('_dashboardEditorHidden', false);
			},
			_styleTilesForInternetExplorer: function() {
				var dashboardTileDivs = Polymer.dom(this.root).querySelectorAll('.dashboards-tile-grid > div');

				for (var i = 0; i < dashboardTileDivs.length; i++) {
					var div = dashboardTileDivs[i];
					var column = (i % this._numberOfColumns + 1) * 2 - 1;
					var row = Math.floor(i / this._numberOfColumns) + 1;

					div.style['-ms-grid-column'] = column;
					div.style['-ms-grid-row'] = row;
				}
			},
			_onResize: function() {
				var containerWidth = this._getContainerWidth();
				var dashboardTileContainer = Polymer.dom(this.root).querySelector('#dashboard-tile-container');

				var numColumns = Math.min(Math.floor(containerWidth / 350), 1) + 1;
				var dashboardTileContainerClass = 'columns-' + numColumns;

				if (dashboardTileContainer.classList.toString().indexOf(dashboardTileContainerClass) === -1) {
					dashboardTileContainer.classList.remove('columns-1');
					dashboardTileContainer.classList.remove('columns-2');
					dashboardTileContainer.classList.add(dashboardTileContainerClass);
				}

				this.set('_numberOfColumns', numColumns);
			},
			_updateDashboardName: function(e) {
				var index = e.detail.index;
				var updatedDisplayName = e.detail.displayName;
				var dashboardToModify = this._dashboards[index];

				var updatedDashboard = Object.assign(Object.create(Object.getPrototypeOf(dashboardToModify)), dashboardToModify);
				updatedDashboard.properties.name = updatedDisplayName;

				this.set('_dashboards.' + index, updatedDashboard);
			}
		});
	</script>
</dom-module>
